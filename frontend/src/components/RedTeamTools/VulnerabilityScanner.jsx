import React, { useState, useMemo } from 'react';
import '../../styles/ToolLayout.css';
import './VulnerabilityScanner.css';

/**
 * Dependency Vulnerability Scanner - CVE lookup and severity scoring
 *
 * Features:
 * - Parse package.json, requirements.txt, Cargo.toml, pom.xml
 * - Check against known vulnerability database
 * - Severity scoring (critical, high, moderate, low)
 * - Dependency tree visualization
 * - Update recommendations
 * - Export SBOM (Software Bill of Materials)
 * - Integration with NVD and GitHub Advisory
 *
 * @returns {JSX.Element} Vulnerability Scanner component
 */
const VulnerabilityScanner = () => {
  const [fileContent, setFileContent] = useState('');
  const [fileType, setFileType] = useState('package.json');
  const [scanResults, setScanResults] = useState(null);
  const [selectedSeverity, setSelectedSeverity] = useState('all');

  /**
   * Known vulnerability database (sample)
   * In production, this would query NVD, Snyk, GitHub Advisory, etc.
   */
  const vulnerabilityDatabase = {
    // npm packages
    'lodash': [
      {
        version: '< 4.17.21',
        cve: 'CVE-2021-23337',
        severity: 'high',
        description: 'Command injection in lodash',
        affected: '< 4.17.21',
        patched: '>= 4.17.21',
        cwe: 'CWE-78',
      },
    ],
    'axios': [
      {
        version: '< 0.21.1',
        cve: 'CVE-2020-28168',
        severity: 'moderate',
        description: 'SSRF vulnerability in axios',
        affected: '< 0.21.1',
        patched: '>= 0.21.1',
        cwe: 'CWE-918',
      },
    ],
    'express': [
      {
        version: '< 4.17.3',
        cve: 'CVE-2022-24999',
        severity: 'moderate',
        description: 'Open redirect in express',
        affected: '< 4.17.3',
        patched: '>= 4.17.3',
        cwe: 'CWE-601',
      },
    ],
    'jsonwebtoken': [
      {
        version: '< 9.0.0',
        cve: 'CVE-2022-23529',
        severity: 'high',
        description: 'Improper signature verification in jsonwebtoken',
        affected: '< 9.0.0',
        patched: '>= 9.0.0',
        cwe: 'CWE-347',
      },
    ],
    'moment': [
      {
        version: '*',
        cve: 'N/A',
        severity: 'low',
        description: 'Moment.js is deprecated and in maintenance mode',
        affected: 'all versions',
        patched: 'Use date-fns or dayjs instead',
        cwe: 'N/A',
      },
    ],

    // Python packages
    'flask': [
      {
        version: '< 2.2.5',
        cve: 'CVE-2023-30861',
        severity: 'high',
        description: 'Cookie parsing vulnerability in Flask',
        affected: '< 2.2.5',
        patched: '>= 2.2.5',
        cwe: 'CWE-20',
      },
    ],
    'requests': [
      {
        version: '< 2.31.0',
        cve: 'CVE-2023-32681',
        severity: 'moderate',
        description: 'Unintended proxy usage in requests',
        affected: '< 2.31.0',
        patched: '>= 2.31.0',
        cwe: 'CWE-444',
      },
    ],
    'pyyaml': [
      {
        version: '< 5.4',
        cve: 'CVE-2020-14343',
        severity: 'critical',
        description: 'Arbitrary code execution in PyYAML',
        affected: '< 5.4',
        patched: '>= 5.4',
        cwe: 'CWE-94',
      },
    ],
    'pillow': [
      {
        version: '< 9.3.0',
        cve: 'CVE-2022-45198',
        severity: 'high',
        description: 'DOS via crafted image in Pillow',
        affected: '< 9.3.0',
        patched: '>= 9.3.0',
        cwe: 'CWE-400',
      },
    ],
    'django': [
      {
        version: '< 4.2.8',
        cve: 'CVE-2023-46695',
        severity: 'critical',
        description: 'SQL injection in Django',
        affected: '< 4.2.8',
        patched: '>= 4.2.8',
        cwe: 'CWE-89',
      },
    ],

    // Rust crates (just examples)
    'serde_json': [
      {
        version: '< 1.0.85',
        cve: 'RUSTSEC-2022-0041',
        severity: 'moderate',
        description: 'Stack overflow in serde_json',
        affected: '< 1.0.85',
        patched: '>= 1.0.85',
        cwe: 'CWE-674',
      },
    ],
  };

  /**
   * Parse package file based on type
   */
  const parsePackageFile = (content, type) => {
    const dependencies = [];

    try {
      if (type === 'package.json') {
        const pkg = JSON.parse(content);
        const deps = { ...pkg.dependencies, ...pkg.devDependencies };

        Object.entries(deps).forEach(([name, version]) => {
          dependencies.push({
            name,
            version: version.replace(/^[\^~]/, ''), // Remove ^ and ~
            type: 'npm',
            ecosystem: 'JavaScript',
          });
        });
      } else if (type === 'requirements.txt') {
        const lines = content.split('\n');

        lines.forEach(line => {
          line = line.trim();
          if (!line || line.startsWith('#')) return;

          const match = line.match(/^([a-zA-Z0-9_-]+)(?:==|>=|<=|~=)?(.+)?$/);
          if (match) {
            dependencies.push({
              name: match[1].toLowerCase(),
              version: match[2] || 'latest',
              type: 'pip',
              ecosystem: 'Python',
            });
          }
        });
      } else if (type === 'Cargo.toml') {
        const lines = content.split('\n');
        let inDeps = false;

        lines.forEach(line => {
          line = line.trim();

          if (line === '[dependencies]') {
            inDeps = true;
            return;
          }

          if (line.startsWith('[') && line !== '[dependencies]') {
            inDeps = false;
            return;
          }

          if (inDeps && line && !line.startsWith('#')) {
            const match = line.match(/^([a-zA-Z0-9_-]+)\s*=\s*"(.+)"$/);
            if (match) {
              dependencies.push({
                name: match[1],
                version: match[2],
                type: 'cargo',
                ecosystem: 'Rust',
              });
            }
          }
        });
      } else if (type === 'pom.xml') {
        // Very basic XML parsing (in production use proper XML parser)
        const depMatches = content.match(/<dependency>[\s\S]*?<\/dependency>/g) || [];

        depMatches.forEach(dep => {
          const groupMatch = dep.match(/<groupId>(.*?)<\/groupId>/);
          const artifactMatch = dep.match(/<artifactId>(.*?)<\/artifactId>/);
          const versionMatch = dep.match(/<version>(.*?)<\/version>/);

          if (groupMatch && artifactMatch) {
            dependencies.push({
              name: `${groupMatch[1]}:${artifactMatch[1]}`,
              version: versionMatch ? versionMatch[1] : 'unknown',
              type: 'maven',
              ecosystem: 'Java',
            });
          }
        });
      }
    } catch (error) {
      console.error('Parse error:', error);
      return [];
    }

    return dependencies;
  };

  /**
   * Check version against vulnerability
   */
  const isVulnerable = (version, vulnVersion) => {
    // Simplified version comparison
    // In production, use semver library
    if (vulnVersion === '*') return true;

    const versionNum = parseFloat(version.replace(/[^0-9.]/g, ''));
    const vulnNum = parseFloat(vulnVersion.replace(/[^0-9.]/g, ''));

    if (vulnVersion.includes('<')) {
      return versionNum < vulnNum;
    }

    return false;
  };

  /**
   * Scan dependencies for vulnerabilities
   */
  const scanDependencies = () => {
    if (!fileContent.trim()) {
      alert('Please paste package file content');
      return;
    }

    const dependencies = parsePackageFile(fileContent, fileType);

    if (dependencies.length === 0) {
      alert('No dependencies found. Please check file format.');
      return;
    }

    const vulnerabilities = [];
    const scannedDeps = [];

    dependencies.forEach(dep => {
      const vulns = vulnerabilityDatabase[dep.name.toLowerCase()];
      let hasVuln = false;

      if (vulns) {
        vulns.forEach(vuln => {
          if (isVulnerable(dep.version, vuln.version)) {
            vulnerabilities.push({
              package: dep.name,
              version: dep.version,
              ecosystem: dep.ecosystem,
              ...vuln,
            });
            hasVuln = true;
          }
        });
      }

      scannedDeps.push({
        ...dep,
        vulnerable: hasVuln,
      });
    });

    // Calculate statistics
    const stats = {
      totalDeps: dependencies.length,
      vulnerableDeps: [...new Set(vulnerabilities.map(v => v.package))].length,
      totalVulns: vulnerabilities.length,
      critical: vulnerabilities.filter(v => v.severity === 'critical').length,
      high: vulnerabilities.filter(v => v.severity === 'high').length,
      moderate: vulnerabilities.filter(v => v.severity === 'moderate').length,
      low: vulnerabilities.filter(v => v.severity === 'low').length,
      ecosystems: [...new Set(dependencies.map(d => d.ecosystem))],
    };

    setScanResults({
      dependencies: scannedDeps,
      vulnerabilities,
      stats,
    });
  };

  /**
   * Filter vulnerabilities by severity
   */
  const filteredVulnerabilities = useMemo(() => {
    if (!scanResults) return [];
    if (selectedSeverity === 'all') return scanResults.vulnerabilities;
    return scanResults.vulnerabilities.filter(v => v.severity === selectedSeverity);
  }, [scanResults, selectedSeverity]);

  /**
   * Load sample package.json
   */
  const loadSample = (type) => {
    setFileType(type);

    if (type === 'package.json') {
      setFileContent(`{
  "name": "my-app",
  "version": "1.0.0",
  "dependencies": {
    "express": "4.17.1",
    "axios": "0.21.0",
    "lodash": "4.17.20",
    "jsonwebtoken": "8.5.1",
    "moment": "2.29.4"
  },
  "devDependencies": {
    "jest": "27.0.0",
    "eslint": "8.0.0"
  }
}`);
    } else if (type === 'requirements.txt') {
      setFileContent(`Flask==2.2.0
requests==2.30.0
PyYAML==5.3.1
Pillow==9.2.0
Django==4.2.5
numpy==1.24.0
pandas==2.0.0`);
    } else if (type === 'Cargo.toml') {
      setFileContent(`[package]
name = "my-app"
version = "0.1.0"

[dependencies]
serde_json = "1.0.80"
tokio = "1.25.0"
reqwest = "0.11.14"`);
    }
  };

  /**
   * Export SBOM (Software Bill of Materials)
   */
  const exportSBOM = () => {
    if (!scanResults) return;

    const sbom = {
      bomFormat: 'CycloneDX',
      specVersion: '1.4',
      version: 1,
      metadata: {
        timestamp: new Date().toISOString(),
        tools: [{
          name: 'DevTools Dashboard Vulnerability Scanner',
          version: '1.0.0',
        }],
      },
      components: scanResults.dependencies.map(dep => ({
        type: 'library',
        name: dep.name,
        version: dep.version,
        purl: `pkg:${dep.type}/${dep.name}@${dep.version}`,
        properties: [
          { name: 'ecosystem', value: dep.ecosystem },
          { name: 'vulnerable', value: dep.vulnerable ? 'true' : 'false' },
        ],
      })),
      vulnerabilities: scanResults.vulnerabilities.map(vuln => ({
        id: vuln.cve,
        source: { name: 'NVD' },
        ratings: [{
          severity: vuln.severity,
          method: 'CVSSv3',
        }],
        cwes: vuln.cwe ? [parseInt(vuln.cwe.replace('CWE-', ''))] : [],
        description: vuln.description,
        affects: [{
          ref: `pkg:${fileType.split('.')[0]}/${vuln.package}@${vuln.version}`,
        }],
      })),
    };

    const blob = new Blob([JSON.stringify(sbom, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sbom-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  /**
   * Get severity color class
   */
  const getSeverityClass = (severity) => {
    return `severity-${severity}`;
  };

  return (
    <div className="tool-layout">
      <div className="tool-header">
        <h1>üîç Dependency Vulnerability Scanner</h1>
        <p>CVE lookup and security audit for npm, pip, cargo, and maven dependencies</p>
      </div>

      {/* Controls */}
      <div className="vuln-controls">
        <div className="file-type-selector">
          <label>Package File Type:</label>
          <select value={fileType} onChange={(e) => setFileType(e.target.value)}>
            <option value="package.json">package.json (npm/Node.js)</option>
            <option value="requirements.txt">requirements.txt (pip/Python)</option>
            <option value="Cargo.toml">Cargo.toml (cargo/Rust)</option>
            <option value="pom.xml">pom.xml (Maven/Java)</option>
          </select>
        </div>

        <button className="btn-scan" onClick={scanDependencies}>
          üîç Scan Dependencies
        </button>

        <div className="sample-buttons">
          <button className="btn-sample" onClick={() => loadSample('package.json')}>
            üì¶ npm Sample
          </button>
          <button className="btn-sample" onClick={() => loadSample('requirements.txt')}>
            üêç Python Sample
          </button>
          <button className="btn-sample" onClick={() => loadSample('Cargo.toml')}>
            ü¶Ä Rust Sample
          </button>
        </div>

        <button className="btn-clear" onClick={() => {
          setFileContent('');
          setScanResults(null);
        }}>
          üóëÔ∏è Clear
        </button>

        {scanResults && (
          <button className="btn-export" onClick={exportSBOM}>
            üíæ Export SBOM
          </button>
        )}
      </div>

      {/* File Editor */}
      <div className="vuln-editor">
        <div className="editor-header">
          <h3>Package File Content ({fileType})</h3>
          <span className="line-count">{fileContent.split('\n').length} lines</span>
        </div>
        <textarea
          className="vuln-textarea"
          value={fileContent}
          onChange={(e) => setFileContent(e.target.value)}
          placeholder={`Paste your ${fileType} content here...`}
          spellCheck={false}
        />
      </div>

      {/* Scan Results */}
      {scanResults && (
        <>
          {/* Statistics */}
          <div className="vuln-stats">
            <div className="stat-card stat-total">
              <div className="stat-icon">üì¶</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.totalDeps}</div>
                <div className="stat-label">Total Dependencies</div>
              </div>
            </div>

            <div className="stat-card stat-vulnerable">
              <div className="stat-icon">‚ö†Ô∏è</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.vulnerableDeps}</div>
                <div className="stat-label">Vulnerable Packages</div>
              </div>
            </div>

            <div className="stat-card stat-critical">
              <div className="stat-icon">üö®</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.critical}</div>
                <div className="stat-label">Critical</div>
              </div>
            </div>

            <div className="stat-card stat-high">
              <div className="stat-icon">‚õî</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.high}</div>
                <div className="stat-label">High</div>
              </div>
            </div>

            <div className="stat-card stat-moderate">
              <div className="stat-icon">‚ö°</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.moderate}</div>
                <div className="stat-label">Moderate</div>
              </div>
            </div>

            <div className="stat-card stat-low">
              <div className="stat-icon">‚ÑπÔ∏è</div>
              <div className="stat-info">
                <div className="stat-value">{scanResults.stats.low}</div>
                <div className="stat-label">Low</div>
              </div>
            </div>
          </div>

          {/* Vulnerabilities */}
          {scanResults.vulnerabilities.length > 0 ? (
            <>
              <div className="vuln-filters">
                <label>Filter by Severity:</label>
                <select value={selectedSeverity} onChange={(e) => setSelectedSeverity(e.target.value)}>
                  <option value="all">All Severities ({scanResults.vulnerabilities.length})</option>
                  <option value="critical">Critical ({scanResults.stats.critical})</option>
                  <option value="high">High ({scanResults.stats.high})</option>
                  <option value="moderate">Moderate ({scanResults.stats.moderate})</option>
                  <option value="low">Low ({scanResults.stats.low})</option>
                </select>
                <span className="filter-info">
                  Showing {filteredVulnerabilities.length} of {scanResults.vulnerabilities.length}
                </span>
              </div>

              <div className="vuln-section">
                <h3>üö® Vulnerabilities Found ({filteredVulnerabilities.length})</h3>
                <div className="vuln-list">
                  {filteredVulnerabilities.map((vuln, idx) => (
                    <div key={idx} className={`vuln-card ${getSeverityClass(vuln.severity)}`}>
                      <div className="vuln-header">
                        <div className="vuln-title">
                          <span className={`severity-badge ${getSeverityClass(vuln.severity)}`}>
                            {vuln.severity.toUpperCase()}
                          </span>
                          <strong>{vuln.package}</strong>
                          <span className="version-badge">v{vuln.version}</span>
                        </div>
                        <div className="vuln-cve">{vuln.cve}</div>
                      </div>

                      <div className="vuln-description">{vuln.description}</div>

                      <div className="vuln-details">
                        <div className="detail-row">
                          <strong>CWE:</strong>
                          <span>{vuln.cwe}</span>
                        </div>
                        <div className="detail-row">
                          <strong>Affected Versions:</strong>
                          <span>{vuln.affected}</span>
                        </div>
                        <div className="detail-row">
                          <strong>Patched Version:</strong>
                          <code>{vuln.patched}</code>
                        </div>
                      </div>

                      <div className="vuln-action">
                        <strong>üõ†Ô∏è Recommended Action:</strong>
                        <p>Update {vuln.package} to {vuln.patched}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          ) : (
            <div className="no-vulns">
              ‚úÖ No known vulnerabilities found! Your dependencies are up to date.
            </div>
          )}

          {/* Dependency List */}
          <div className="deps-section">
            <h3>üìã All Dependencies ({scanResults.dependencies.length})</h3>
            <div className="deps-table-container">
              <table className="deps-table">
                <thead>
                  <tr>
                    <th>Package</th>
                    <th>Version</th>
                    <th>Ecosystem</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {scanResults.dependencies.map((dep, idx) => (
                    <tr key={idx} className={dep.vulnerable ? 'vulnerable' : ''}>
                      <td><strong>{dep.name}</strong></td>
                      <td><code>{dep.version}</code></td>
                      <td>{dep.ecosystem}</td>
                      <td>
                        {dep.vulnerable ? (
                          <span className="status-vulnerable">‚ö†Ô∏è Vulnerable</span>
                        ) : (
                          <span className="status-safe">‚úÖ Safe</span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </>
      )}

      {/* Info Panel */}
      <div className="vuln-info">
        <h3>‚ÑπÔ∏è About Vulnerability Scanning</h3>
        <p>
          This tool scans your project dependencies for known security vulnerabilities using CVE
          (Common Vulnerabilities and Exposures) data. Regular scanning helps maintain secure
          software supply chains.
        </p>
        <h4>Best Practices:</h4>
        <ul>
          <li>Scan dependencies regularly (weekly or before each release)</li>
          <li>Update vulnerable packages immediately, especially critical/high severity</li>
          <li>Use lock files (package-lock.json, requirements.txt with ==) for reproducible builds</li>
          <li>Enable automated dependency updates (Dependabot, Renovate)</li>
          <li>Review transitive dependencies (dependencies of dependencies)</li>
          <li>Maintain an SBOM for compliance and audit trails</li>
        </ul>
        <h4>Data Sources:</h4>
        <ul>
          <li><strong>NVD:</strong> National Vulnerability Database</li>
          <li><strong>GitHub Advisory:</strong> Security advisories for open source</li>
          <li><strong>Snyk:</strong> Commercial vulnerability database</li>
          <li><strong>npm audit:</strong> Built-in npm security scanner</li>
          <li><strong>pip-audit:</strong> Python package security scanner</li>
        </ul>
      </div>
    </div>
  );
};

export default VulnerabilityScanner;
